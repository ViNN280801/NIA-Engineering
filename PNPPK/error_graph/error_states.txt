# Граф ошибочных ситуаций программы управления РРГ и реле

## 1. Вершина - Включение программы

### 1.1. Оба устройства подключены физически
- **Исход 1.1.1:** Все порты обнаружены корректно
  - Программа загружает сохраненные порты или устанавливает порты по умолчанию
  - UI включен, доступны все элементы управления
  
- **Исход 1.1.2:** Порты, использованные при предыдущем запуске, недоступны
  - Показывается предупреждение о недоступности сохраненных портов
  - Программа автоматически пытается выбрать другие доступные порты
  - UI включен, доступны все элементы управления

### 1.2. Реле отключено физически
- **Исход 1.2.1:** Доступен только один COM-порт
  - Программа определяет, что не хватает COM-портов
  - UI включен, но при попытке подключения будет ошибка
  
- **Исход 1.2.2:** Сохраненный порт реле недоступен
  - Показывается предупреждение о недоступности сохраненного порта
  - При попытке подключения возникнет ошибка "Не удалось подключиться к реле"

### 1.3. РРГ отключено физически
- **Исход 1.3.1:** Доступен только один COM-порт
  - Программа определяет, что не хватает COM-портов
  - UI включен, но при попытке подключения будет ошибка
  
- **Исход 1.3.2:** Сохраненный порт РРГ недоступен
  - Показывается предупреждение о недоступности сохраненного порта
  - При попытке подключения возникнет ошибка "Не удалось подключиться к РРГ"

### 1.4. Оба устройства отключены физически
- **Исход 1.4.1:** Нет доступных COM-портов
  - Показывается предупреждение "Недостаточно доступных портов. Графический интерфейс отключен"
  - UI отключен, работа с программой невозможна
  - Кнопка "Обновить порты" активна, позволяет проверить наличие портов после подключения устройств

## 2. Вершина - Между запусками программы (нажатия на кнопку "Включить/Выключить РРГ")

### 2.1. Нажатие "Включить РРГ", оба устройства подключены физически
- **Исход 2.1.1:** Реле и РРГ успешно подключены
  - Показывается сообщение "Реле подключено к порту X"
  - Показывается сообщение "РРГ подключено к порту Y"
  - Кнопка меняет текст на "Выключить РРГ"
  - Начинаются измерения, обновляется график

- **Исход 2.1.2:** Выбран один и тот же порт для реле и РРГ
  - Показывается ошибка "Реле и РРГ подключены к одному порту"
  - Подключение не выполняется, кнопка остается в состоянии "Включить РРГ"

- **Исход 2.1.3:** Ошибка подключения к реле
  - Показывается ошибка "Не удалось подключиться к реле на порту X"
  - Подключение к РРГ не выполняется
  - Кнопка остается в состоянии "Включить РРГ"

- **Исход 2.1.4:** Ошибка подключения к РРГ (реле подключено успешно)
  - Показывается сообщение "Реле подключено к порту X"
  - Показывается ошибка РРГ
  - Кнопка остается в состоянии "Включить РРГ"
  - Реле остается подключенным

### 2.2. Нажатие "Выключить РРГ"
- **Исход 2.2.1:** Оба устройства успешно отключены
  - Показывается сообщение "РРГ отключено"
  - Показывается сообщение "Реле отключено"
  - Кнопка меняет текст на "Включить РРГ"
  - Измерения прекращаются, график не обновляется

- **Исход 2.2.2:** Ошибка при отключении РРГ
  - Показывается сообщение ошибки РРГ
  - Программа пытается отключить реле

- **Исход 2.2.3:** Ошибка при отключении реле
  - Показывается сообщение ошибки реле
  - Кнопка меняет текст на "Включить РРГ" в любом случае

## 3. Вершина - Во время работы программы

### 3.1. Физическое отключение устройств во время работы
- **Исход 3.1.1:** Физическое отключение USB-адаптера с реле
  - Обнаруживается уменьшение числа доступных портов
  - Вызывается _handle_device_disconnection с сообщением "Обнаружено отключение USB-адаптера"
  - Все соединения закрываются
  - Показывается критическое сообщение об ошибке подключения
  - Кнопка переходит в состояние "Включить РРГ"
  - Список портов обновляется

- **Исход 3.1.2:** Физическое отключение USB-адаптера с РРГ
  - Обнаруживается уменьшение числа доступных портов
  - Вызывается _handle_device_disconnection с сообщением "Обнаружено отключение USB-адаптера"
  - Все соединения закрываются
  - Показывается критическое сообщение об ошибке подключения
  - Кнопка переходит в состояние "Включить РРГ"
  - Список портов обновляется

- **Исход 3.1.3:** Физическое отключение обоих устройств
  - Обнаруживается уменьшение числа доступных портов
  - Вызывается _handle_device_disconnection с сообщением "Обнаружено отключение USB-адаптера"
  - Все соединения закрываются
  - Показывается критическое сообщение об ошибке подключения
  - Кнопка переходит в состояние "Включить РРГ"
  - Список портов обновляется

### 3.2. Потеря связи с устройствами без физического отключения
- **Исход 3.2.1:** Потеря связи с РРГ, но устройство физически подключено
  - При вызове _check_gfr_connectivity генерируется исключение
  - Вызывается _handle_device_disconnection с сообщением "Потеряна связь с РРГ"
  - Все соединения закрываются
  - Показывается критическое сообщение об ошибке подключения
  - Кнопка переходит в состояние "Включить РРГ"

- **Исход 3.2.2:** Потеря связи с реле, но устройство физически подключено
  - При вызове _check_relay_connectivity генерируется исключение
  - Вызывается _handle_device_disconnection с сообщением "Потеряна связь с реле"
  - Все соединения закрываются
  - Показывается критическое сообщение об ошибке подключения
  - Кнопка переходит в состояние "Включить РРГ"

### 3.3. Остановка измерений без потери связи
- **Исход 3.3.1:** Измерения прекратились, хотя РРГ подключен
  - Определяется, что прошло более 10 секунд с момента последнего измерения
  - Устанавливается флаг measurement_stalled = True
  - Вызывается _perform_auto_recovery
  - Показывается предупреждение "Измерения прекратились. Выполняется автоматическое восстановление соединения..."
  - Все соединения закрываются и затем восстанавливаются автоматически
  
- **Исход 3.3.2:** Автоматическое восстановление успешно
  - Соединения восстанавливаются
  - Показывается сообщение "Соединение восстановлено успешно. Измерения продолжаются."
  - Измерения возобновляются

- **Исход 3.3.3:** Автоматическое восстановление не удалось
  - Соединения не восстанавливаются
  - Показывается сообщение "Не удалось восстановить соединение автоматически"
  - Показывается предупреждение с рекомендациями по перезапуску программы

### 3.4. Ошибки при управлении уставкой расхода
- **Исход 3.4.1:** Попытка задать уставку расхода при выключенном РРГ
  - Показывается предупреждение "РРГ не включен. Сначала включите РРГ, чтобы задать уставку расхода."

- **Исход 3.4.2:** Введено пустое значение расхода
  - Показывается сообщение "Значение заданного расхода пустое."

- **Исход 3.4.3:** Введено некорректное значение расхода
  - Показывается сообщение "Неверное значение заданного расхода"

- **Исход 3.4.4:** Ошибка при задании расхода на подключенном РРГ
  - Вызывается _gfr_show_error_msg, показывается ошибка РРГ

- **Исход 3.4.5:** Успешное задание расхода
  - Показывается сообщение "Успешно задан расход X [см3/мин]."

## 4. Вершина - Работа с данными и графиком

### 4.1. Очистка графика
- **Исход 4.1.1:** График успешно очищен
  - Данные графика сбрасываются
  - Время начала измерений сбрасывается
  - График перерисовывается
  - Показывается сообщение "График очищен. Начинаем новые измерения."

### 4.2. Сохранение данных в CSV
- **Исход 4.2.1:** Нет данных для сохранения
  - Показывается предупреждение "Нет данных для сохранения. Сначала запустите измерения."

- **Исход 4.2.2:** Данные успешно сохранены
  - Данные записываются в файл flow_data_YYYY-MM-DD_HH-MM-SS.csv
  - Показывается сообщение "Данные сохранены в файл: X"
  - Показывается информационное сообщение "Данные успешно сохранены в файл: X"

- **Исход 4.2.3:** Ошибка при сохранении данных
  - Показывается критическое сообщение "Не удалось сохранить данные: X"
  - Показывается сообщение в логе "Ошибка сохранения данных: X"

### 4.3. Сохранение графика как изображения
- **Исход 4.3.1:** Нет данных для сохранения графика
  - Показывается предупреждение "Нет данных для сохранения графика. Сначала запустите измерения."

- **Исход 4.3.2:** График успешно сохранен
  - График сохраняется в файл flow_graph_YYYY-MM-DD_HH-MM-SS.png
  - Показывается сообщение "График сохранен в файл: X"
  - Показывается информационное сообщение "График успешно сохранен в файл: X"

- **Исход 4.3.3:** Ошибка при сохранении графика
  - Показывается критическое сообщение "Не удалось сохранить график: X"
  - Показывается сообщение в логе "Ошибка сохранения графика: X"

## 5. Вершина - Завершение работы программы

### 5.1. Закрытие окна программы
- **Исход 5.1.1:** Пользователь подтверждает закрытие
  - Сохраняются текущие настройки портов
  - Выполняется _safe_close_connections для безопасного отключения устройств
  - Программа закрывается

- **Исход 5.1.2:** Пользователь отменяет закрытие
  - Окно остается открытым, программа продолжает работу

### 5.2. Закрытие по горячим клавишам (Ctrl+W, Ctrl+Q)
- **Исход 5.2.1:** Пользователь подтверждает закрытие
  - Сохраняются текущие настройки портов
  - Выполняется _safe_close_connections для безопасного отключения устройств
  - Программа закрывается

- **Исход 5.2.2:** Пользователь отменяет закрытие
  - Программа продолжает работу

### 5.3. Ошибки при закрытии соединений
- **Исход 5.3.1:** Ошибка при отключении РРГ
  - Записывается сообщение "Ошибка при отключении РРГ: X"
  - Программа пытается отключить реле

- **Исход 5.3.2:** Ошибка при отключении реле
  - Записывается сообщение "Ошибка при отключении реле: X"
  - Программа продолжает процесс закрытия

- **Исход 5.3.3:** Общая ошибка при закрытии соединений
  - Записывается сообщение "Ошибка при закрытии соединений: X"
  - Программа продолжает процесс закрытия в любом случае 